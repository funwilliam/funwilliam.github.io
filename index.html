<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="image/icon.svg">
    <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js"
        integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
    <title>捷拓工程部品異及時通知系統</title>
    <style>
        .container {
            max-width: 1300px;
            margin: auto;
        }

        .contentarea {
            font-size: 16px;
            font-family: "Lucida Grande", "Arial", sans-serif;
            max-width: 80%;
            margin: auto;
        }

        .camera {
            max-width: 100%;
            margin: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            border: 1px solid black;
            box-shadow: 2px 2px 3px black;
        }

        .output {
            max-width: 100%;
            margin: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid black;
            box-shadow: 2px 2px 3px black;
        }

        #video {
            max-width: 100%;
        }

        #photo {
            max-width: 100%;
        }

        #startbutton {
            display: block;
            position: absolute;
            /* 修改：绝对定位 */
            left: 50%;
            /* 新增：水平居中 */
            transform: translateX(-50%);
            /* 新增：精确居中调整 */
            bottom: 5%;
            /* 修改：相对于父元素底部的位置 */
            background-color: rgba(0, 150, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.7);
            box-shadow: 0px 0px 1px 2px rgba(0, 0, 0, 0.2);
            font-size: 14px;
            font-family: "Lucida Grande", "Arial", sans-serif;
            color: rgba(255, 255, 255, 1);
        }

        #canvas {
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="contentarea">
            <h2>捷拓工程部品異及時通知系統</h2>
            <p>請使用下方相機進行拍攝</p>
            <div class="camera">
                <video id="video" autoplay="true" playsinline>视频流目前不可用。</video>
                <button id="startbutton">拍攝照片</button>
            </div>
            <canvas id="canvas"></canvas>
            <br>
            <br>
            <div class="output">
                <img id="photo" alt="拍攝到的圖像" />
            </div>
            <p id="debug-console"></p>
            <br>
            <br>
            <p>Copyright © 2023 捷拓科技-工程部 昱展</p>
        </div>
    </div>

    <script>
        (() => {
            // The width and height of the captured photo. We will set the
            // width to the value defined here, but the height will be
            // calculated based on the aspect ratio of the input stream.

            let width = 1080; // We will scale the photo width to this
            let height = 1440; // This will be computed based on the input stream

            // |streaming| indicates whether or not we're currently streaming
            // video from the camera. Obviously, we start at false.

            let streaming = false;
            let init_google = false;

            // The various HTML elements we need to configure or control. These
            // will be set by the startup() function.

            let video = null;
            let canvas = null;
            let photo = null;
            let startbutton = null;
            let sourceWidth = null;
            let sourceHeight = null;
            let sourceX = null;
            let sourceY = null;
            let drive = null;

            video = document.getElementById("video");
            canvas = document.getElementById("canvas");
            photo = document.getElementById("photo");
            startbutton = document.getElementById("startbutton");

            function adjustVideoSize() {
                let maxWidth = 1080; // 最大宽度限制
                width = Math.min(window.innerWidth, maxWidth); // 取屏幕宽度和最大宽度中较小的一个
                height = 4 * width / 3; // 寬:高=3:4

                if (video && streaming) {
                    if (video.videoHeight * 3 > video.videoWidth * 4) {
                        sourceWidth = video.videoWidth;
                        sourceHeight = video.videoWidth * 4 / 3;
                        sourceX = 0;
                        sourceY = (video.videoHeight - sourceHeight) / 2;
                    }
                    else {
                        sourceWidth = video.videoHeight * 3 / 4;
                        sourceHeight = video.videoHeight;
                        sourceX = (video.videoWidth - sourceWidth) / 2;
                        sourceY = 0;
                    }
                    let rate = (100 * sourceWidth / width).toString() + '%';
                    height = video.videoHeight / (video.videoWidth / width);
                    if (isNaN(height)) {
                        height = 4 * width / 3; // 寬:高=3:4
                    }
                    $('#video').width(sourceWidth).height(sourceHeight);
                    $('#canvas').width(sourceWidth).height(sourceHeight);
                    $('#photo').width(sourceWidth).height(sourceHeight);
                    $('#debug-console').text('sourceWidth=' + sourceWidth.toString() + ' sourceHeight=' + sourceHeight.toString() + '縮放=' + rate.toString());
                }
                else {
                    $('#video').width(width).height(height);
                    $('#photo').width(width).height(height);
                    $('#debug-console').text('videoWidth=' + video.videoWidth.toString() + ' videoheight=' + video.videoHeight.toString());
                }
            }
            adjustVideoSize();
            window.addEventListener("resize", adjustVideoSize, false); // 添加窗口大小改变时的监听器

            function startup() {
                navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: "environment",
                        frameRate: { min: 10, max: 120 },
                        width: 1920,
                        height: 1080
                    },
                    audio: false
                }).then((stream) => {
                    video.srcObject = stream;
                    video.play();
                }).catch((err) => {
                    console.error(`An error occurred: ${err}`);
                });

                video.addEventListener(
                    "canplay",
                    (ev) => {
                        if (!streaming) {

                            height = video.videoHeight / (video.videoWidth / width);

                            // Firefox currently has a bug where the height can't be read from
                            // the video, so we will make assumptions if this happens.

                            if (isNaN(height)) {
                                height = 4 * width / 3;
                            }

                            $('#video').width(width).height(height);
                            $('#photo').width(width).height(height);
                            streaming = true;
                        }
                        adjustVideoSize();
                    },
                    false,
                );

                startbutton.addEventListener(
                    "click",
                    (ev) => {
                        takepicture();
                        ev.preventDefault();
                    },
                    false,
                );

                clearphoto();
            }

            // Fill the photo with an indication that none has been
            // captured.

            function clearphoto() {
                const context = canvas.getContext("2d");
                context.fillStyle = "#AAA";
                context.fillRect(0, 0, canvas.width, canvas.height);

                const data = canvas.toDataURL("image/png");
                photo.setAttribute("src", data);
            }

            // Capture a photo by fetching the current contents of the video
            // and drawing it into a canvas, then converting that to a PNG
            // format data URL. By drawing it on an offscreen canvas and then
            // drawing that to the screen, we can change its size and/or apply
            // other changes before drawing it.

            function takepicture() {
                const context = canvas.getContext("2d");
                if (sourceWidth && sourceHeight) {
                    $('#canvas').width(sourceWidth).height(sourceHeight);
                    context.drawImage(video, sourceX, sourceY, sourceWidth, sourceHeight, 0, 0, canvas.width, canvas.height);

                    const data = canvas.toDataURL("image/png");
                    photo.setAttribute("src", data);
                    uploadFile(data)
                }
                else {
                    clearphoto();
                }

            }

            function google_client_init() {
                const { google } = require('googleapis');

                // 加载服务账户密钥
                const serviceAccount = require('service-account.json');

                // 配置JWT客户端
                const jwtClient = new google.auth.JWT(
                    serviceAccount.client_email,
                    null,
                    serviceAccount.private_key,
                    ['https://www.googleapis.com/auth/drive'],
                    null
                );

                // Google Drive API
                drive = google.drive({ version: 'v3', auth: jwtClient });
            }

            // 上传文件
            function uploadFile(fileContent) {
                if (!init_google) {
                    google_client_init()
                    init_google = true
                }
                if (drive) {
                    const fileMetadata = {
                        'name': `${Date().getTime()}.png`, // 文件名
                    };
                    const media = {
                        mimeType: 'image/png',
                        body: fileContent // 文件内容
                    };

                    drive.files.create({
                        resource: fileMetadata,
                        media: media,
                        fields: 'id'
                    }, (err, file) => {
                        if (err) {
                            // 处理错误
                            console.error(err);
                        } else {
                            console.log('File Id:', file.id);
                        }
                    });
                }
                else {
                    console.log('google 客戶端建立失敗，無法上傳檔案')
                }
            }

            // Set up our event listener to run the startup process
            // once loading is complete.
            window.addEventListener("load", startup, false);
        })();
    </script>
</body>

</html>